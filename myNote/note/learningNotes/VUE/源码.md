# VUE源码思路

## VUE2.X

### 响应式

基于ES5提供的**Object.defineProperty()**，覆写属性的getter和setter；

```javascript
    <script>
        class VueDemo {
            constructor(){
                this.autoUpdateFun = null
            }
            observe(obj,_this=this) {
                Object.keys(obj).forEach(key => {
                    let keyValue = obj[key]
                    let dependList = new Set()
                    Object.defineProperty(obj, key, {
                        get() {
                            //收集该变量的依赖项
                            if (_this.autoUpdateFun) dependList.add(_this.autoUpdateFun)
                            return keyValue
                        },
                        set(now) {
                            keyValue = now
                            // 获取该变量所有依赖，触发更新
                            dependList.forEach(fun => {
                                fun()
                            })
                        },
                    })
                });
            }

            //autoRun：将更新函数添加到依赖项，以响应setter自动执行
            autoRun(updataFun,_this=this) {
                function autoUpdata() {
                    _this.autoUpdateFun = autoUpdata
                    updataFun()
                    //updataFun()中访问属性值，触发对应getter，将当前更新操作放入该值的依赖列表dependList
                    //得益于JS单线程特征，同一时间autoUpdateFun只为当前值。
                    _this.autoUpdateFun = null
                }
                autoUpdata()
            }
        }

    </script>
    <script>
        let state = {
            a: 1,
            b: 100
        }
        let vuedemo = new VueDemo()
        vuedemo.observe(state)

        //响应式代码块
        vuedemo.autoRun(() => {
            //该部分访问过的值（即，调用过getter），将会具有响应式特征
            console.log('this is autoRun a:', state.a)//1
        })
        state.a = 5  //触发setter，执行依赖state.a的autoRun
        console.log(state.b)
        state.b = 500 //没有对应autoRun，不具有响应式
    </script>
```

*补充*：

- autoRun()中只能触发getter，触发setter会陷入无限循环
- autoRun()只会响应对应变量setter，不会响应getter（没有意义）





## VUE3.X





