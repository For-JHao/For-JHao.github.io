# 缓存策略

缓存有两种：私有和共享缓存

- 私有缓存（浏览器缓存），只作用于单个用户；
- 共享缓存（代理缓存），在第三方服务器上缓存，如网关缓存、CDN等，可以被多个用户使用；

通过缓存，可以减少向服务器发起的重复资源请求，减少加载时间，减轻服务器性能开销；

但当缓存资源过期时（服务器相应资源发生改变），浏览器应该重新获取服务器资源，而不是又从缓存区获取数据；

针对该问题的处理策略，即缓存**策略**，有两种：强缓存和协商缓存；

两种缓存策略都是通过设置HTTP Header来实现

## 强缓存

由浏览器确定缓存是否可用，不会向服务器发送请求；

两种设置方式：（cache-control优先级高于expires）

- **expires** 指定缓存过期**日期**，受限于本地时间，修改本地时间可导致缓存失效

- **Cache-Control** 单向的消息头字段，使用多个指令可用逗号分隔：
  
  - max-age=< seconds > 指定过期**持续时间**，该时间内请求强制走缓存
  - s-maxage=< seconds> 覆盖max-age或expires ，仅用于共享缓存
  - no-store 不存储任何缓存，即不使用任何缓存
  - no-cache 绕开强缓存，让服务器验证请求（走协商缓存）
  - ...

*补充*：即使一个网络请求是从本地缓存里获取的数据，成功时，返回的HTTP状态码仍然为200；

## 协商缓存

浏览器携带缓存标识发起请求，根据服务器返回值决定是否使用缓存；

同样有两种方式：（ETag优先级高于Last-Modified）

- **Last-Modified** 一个响应头部字段，记录该响应文件的最后修改**日期时间**（只能精确到秒）。**请求头**用字段**If-Modified-Since**携带该值进行验证，服务器收到和自己最后修改时间对比，超过该时间即文件发生变化，返回新资源，否则返回304；
- **ETag** 响应头字段，记录一个服务器根据资源生成的**hash值或版本号**。下次请求时，**请求头**使用**If-None-Match**字段携带该值。服务器进行匹配，不一样返回新内容，一样返回304通知浏览器使用缓存；

**总结**

- 缓存寿命判断顺序：

​        Cache-Control: max-age--(没有)-->Expires--(没有)---->ETag---(没有)--->Last-Modified

- 在**强缓存判断过期**的情况下，再提交由服务器进行协商缓存判断，未发生数据更改，则通知浏览器仍然使用缓存；
- 先判断ETag意义在于，Last-Modified时间只能精确到秒，有些修改比较频繁的数据可能低于秒；又或者修改时间变了，而实际内容并没有改变；

## 三级缓存

访问缓存的优先级；

1. 内存中查找
2. 硬盘中查找
3. 发起网络请求

参考：

[HTTP 缓存 - HTTP | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching)

[前端优化：浏览器缓存技术介绍 - 掘金 (juejin.cn)](https://juejin.cn/post/6844903672556552205)

[浏览器缓存、DNS缓存、CDN缓存 - 掘金 (juejin.cn)](https://juejin.cn/post/6855469171703185416)
